<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JAMBWEB</title>
    <style>
        #polling-toggle {
            width: 30px;
            height: 30px;
            background-color: blue;
            border-radius: 50%;
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
        th {
            text-align: left;
        }
    </style>
<script>
    let pollingActive = true;
    let data = [];
    let currentSort = { method: 'numerical', direction: 1 };
    let currentEditingTd = null;
    
    function handleSortClick(sortType) {
        // Toggle direction only if the same sort type is clicked again
        if (currentSort.method === sortType) {
            currentSort.direction *= -1;
        } else {
            currentSort.method = sortType;
            currentSort.direction = 1; // Default to ascending order for new sort type
        }
        setSort();
    }

    function updateData() {
        if (!pollingActive) return;

        fetch('/update_data')
            .then(response => response.json())
            .then(fetchedData => {
                data = Object.entries(fetchedData).map(([key, reg]) => reg);
                setSort(currentSort);
            });
    }

    function replaceCellWithInput(td) {
        let originalValue = td.querySelector('input[type="text"]') ? td.querySelector('input[type="text"]').value : td.textContent.trim();
        const inputHtml = `<input type='text' value='${originalValue}' />`;
        const buttonHtml = `<button class='submit-edit'>Submit</button>`;
        td.innerHTML = inputHtml + buttonHtml;
        pollingActive = false;
        document.getElementById('polling-toggle').style.backgroundColor = 'red';
        currentEditingTd = td;
    }

    // Submits the edited value to the server and updates the UI accordingly
    function submitEdit() {
        if (!currentEditingTd) return;
        const registerName = currentEditingTd.closest('tr').querySelector('.name').textContent;
        const inputElement = currentEditingTd.querySelector('input[type="text"]');
        const newValue = inputElement.value;

        const data = new FormData();
        data.append('register_name', registerName);
        data.append('value', newValue);

        fetch('/write_data', { method: 'POST', body: data })
            .then(response => response.json())
            .then(jsonResponse => {
                if (jsonResponse.success) {
                    currentEditingTd.innerHTML = `${newValue} <button class='edit-btn'>Edit</button>`;
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                currentEditingTd = null;
                pollingActive = true;
                document.getElementById('polling-toggle').style.backgroundColor = 'blue';
            });
    }

    function addClickListeners() {
        document.querySelectorAll('.value').forEach(td => {
            td.style.cursor = 'pointer';
            td.onclick = () => replaceCellWithInput(td);
        });
    }

    function setSort() {
        switch (currentSort.method) {
            case 'numerical':
                data.sort((a, b) => currentSort.direction * (a.address - b.address));
                break;
            case 'alphabetical':
                data.sort((a, b) => currentSort.direction * a.name.localeCompare(b.name));
                break;
            case 'value':
                data.sort((a, b) => currentSort.direction * a.value.localeCompare(b.value));
                break;
            case 'hint':
                data.sort((a, b) => currentSort.direction * a.hint.localeCompare(b.hint));
                break;
        }
        renderTable();
    }

    function renderTable() {
        const tableBody = document.getElementById('data-table-body');
        tableBody.innerHTML = ''; // Clear existing table rows

        data.forEach(reg => {
            const row = document.createElement('tr');
            row.id = 'address-' + reg.address;

            row.innerHTML = `
                <td>${reg.address}</td>
                <td class="name">${reg.name}</td>
                <td class="query">${reg.query}</td>
                <td class="value">${reg.value}</td>
                <td class="hint">${reg.hint}</td>
            `;
            tableBody.appendChild(row);
        });
        addClickListeners(); // Call this after rendering the table
    }

    function togglePolling() {
        pollingActive = !pollingActive;
        const circle = document.getElementById('polling-toggle');
        if (pollingActive) {
            circle.style.backgroundColor = 'blue';
        } else {
            circle.style.backgroundColor = 'red';
        }
    }

    setInterval(updateData, 1000); // Update every second

    window.onload = function() {
        document.getElementById('polling-toggle').addEventListener('click', togglePolling);
        document.getElementById('sort-address').addEventListener('click', () => handleSortClick('numerical'));
        document.getElementById('sort-name').addEventListener('click', () => handleSortClick('alphabetical'));
        document.getElementById('sort-value').addEventListener('click', () => handleSortClick('value'));
        document.getElementById('sort-hint').addEventListener('click', () => handleSortClick('hint'));
        addClickListeners(); // Call this after initial load

        // Event delegation for submit button
        document.getElementById('data-table-body').addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('submit-edit')) {
                if (currentEditingTd) {
                    const input = currentEditingTd.querySelector('input');
                    if (input) {
                        const newValue = input.value;
                        submitEdit(currentEditingTd, newValue);
                        currentEditingTd = null;
                    }
                }
            }
        });

    };
</script>

</head>
<body>
    <div id="polling-toggle"></div>
    <h1></h1>
    <table id="data-table">
        <thead>
            <tr>
                <th id="sort-address"><a href="#">Address</a></th>
                <th id="sort-name"><a href="#">Name</a></th>
                <th>
                    {% if display_all %}
                        <a href="/">Query</a>
                    {% else %}
                        <a href="/unfiltered">Query</a>
                    {% endif %}
                </th>
                <th id="sort-value"><a href="#">Value</a></th>
                <th id="sort-hint"><a href="#">Hint</a></th>
            </tr>
        </thead>
        <tbody id="data-table-body">
            {% for key, reg in data.items() %}
            <tr id="address-{{ reg.address }}">
                <td>{{ reg.address }}</td>
                <td class="name">{{ reg.name }}</td>
                <td class="query">{{ reg.query }}</td>
                <td class="value">{{ reg.value }}</td>
                <td class="hint">{{ reg.hint }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>
